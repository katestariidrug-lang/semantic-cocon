
=== CONTEXT around line 6 (1-31) ===
0001: """
0002: ФАЙЛ: scripts/orchestrator.py
0003: НАЗНАЧЕНИЕ: Оркестратор двухпроходного workflow:
0004:   - decide  : запуск PASS_1 → получить ARCH_DECISION_JSON → сохранить snapshot+hash
0005:   - approve : человеческое подтверждение конкретного snapshot-hash
0006:   - execute : запуск PASS_2 только если snapshot верифицирован и подтверждён
0007: 
0008: ИСПОЛЬЗУЕТСЯ: VS Code tasks / CLI.
0009: ДОСТУП LLM: запрещён (LLM не управляет state, не проверяет immutability).
0010: """
0011: 
0012: from __future__ import annotations
0013: 
0014: import argparse
0015: import json
0016: import sys
0017: from pathlib import Path
0018: from typing import Any, Dict, Tuple
0019: 
0020: from scripts.state_utils import save_snapshot, verify_snapshot_files, fingerprint_immutable_architecture
0021: 
0022: ROOT = Path(__file__).resolve().parents[1]  # project-root/
0023: PROMPTS_DIR = ROOT / "prompts"
0024: INPUT_DIR = ROOT / "input"
0025: STATE_DIR = ROOT / "state"
0026: OUTPUTS_DIR = ROOT / "outputs"
0027: 
0028: SNAPSHOTS_DIR = STATE_DIR / "snapshots"
0029: APPROVALS_DIR = STATE_DIR / "approvals"
0030: 
0031: PASS_1_PROMPT_PATH = PROMPTS_DIR / "pass_1_decide.md"

=== CONTEXT around line 32 (7-57) ===
0007: 
0008: ИСПОЛЬЗУЕТСЯ: VS Code tasks / CLI.
0009: ДОСТУП LLM: запрещён (LLM не управляет state, не проверяет immutability).
0010: """
0011: 
0012: from __future__ import annotations
0013: 
0014: import argparse
0015: import json
0016: import sys
0017: from pathlib import Path
0018: from typing import Any, Dict, Tuple
0019: 
0020: from scripts.state_utils import save_snapshot, verify_snapshot_files, fingerprint_immutable_architecture
0021: 
0022: ROOT = Path(__file__).resolve().parents[1]  # project-root/
0023: PROMPTS_DIR = ROOT / "prompts"
0024: INPUT_DIR = ROOT / "input"
0025: STATE_DIR = ROOT / "state"
0026: OUTPUTS_DIR = ROOT / "outputs"
0027: 
0028: SNAPSHOTS_DIR = STATE_DIR / "snapshots"
0029: APPROVALS_DIR = STATE_DIR / "approvals"
0030: 
0031: PASS_1_PROMPT_PATH = PROMPTS_DIR / "pass_1_decide.md"
0032: PASS_2_PROMPT_PATH = PROMPTS_DIR / "pass_2_execute.md"
0033: 
0034: TASK_JSON_PATH = INPUT_DIR / "task.json"
0035: ARCH_SCHEMA_PATH = STATE_DIR / "arch_decision_schema.json"
0036: 
0037: 
0038: def read_text(path: Path) -> str:
0039:     if not path.exists():
0040:         raise FileNotFoundError(f"Файл не найден: {path}")
0041:     return path.read_text(encoding="utf-8")
0042: 
0043: 
0044: def read_json(path: Path) -> Dict[str, Any]:
0045:     return json.loads(read_text(path))
0046: 
0047: 
0048: def write_text(path: Path, content: str) -> None:
0049:     path.parent.mkdir(parents=True, exist_ok=True)
0050:     path.write_text(content, encoding="utf-8")
0051: 
0052: 
0053: def write_json_pretty(path: Path, obj: Any) -> None:
0054:     path.parent.mkdir(parents=True, exist_ok=True)
0055:     path.write_text(json.dumps(obj, ensure_ascii=False, indent=2), encoding="utf-8")
0056: 
0057: 

=== CONTEXT around line 204 (179-229) ===
0179:     if not snap_path.exists():
0180:         raise FileNotFoundError(f"Snapshot не найден: {snap_path}")
0181: 
0182:     # hash рядом, по имени (task__prefix.sha256)
0183:     hash_path = snap_path.with_suffix("").with_suffix(".sha256")  # .snapshot.json -> .sha256
0184:     # если не угадали суффикс, попробуем простой вариант:
0185:     if not hash_path.exists():
0186:         # fallback: заменить ".snapshot.json" на ".sha256"
0187:         hash_path = Path(str(snap_path).replace(".snapshot.json", ".sha256"))
0188:     if not hash_path.exists():
0189:         raise FileNotFoundError(f"Hash file не найден рядом со snapshot: {hash_path}")
0190: 
0191:     ok, msg = verify_snapshot_files(snap_path, hash_path)
0192:     if not ok:
0193:         raise ValueError(f"VERIFY_FAIL: {msg}")
0194: 
0195:     hash_hex = hash_path.read_text(encoding="utf-8").strip()
0196:     APPROVALS_DIR.mkdir(parents=True, exist_ok=True)
0197:     approval_path = approval_file_for_hash(hash_hex)
0198:     approval_path.write_text("approved\n", encoding="utf-8")
0199: 
0200:     print("APPROVE_OK")
0201:     print(f"APPROVAL: {approval_path}")
0202: 
0203: 
0204: def cmd_execute(snapshot_path: str) -> None:
0205:     """
0206:     PASS_2 выполняется ТОЛЬКО если:
0207:       1) snapshot hash верифицируется
0208:       2) существует approvals/<hash>.approved
0209:     """
0210:     snap_path = Path(snapshot_path)
0211:     if not snap_path.exists():
0212:         raise FileNotFoundError(f"Snapshot не найден: {snap_path}")
0213: 
0214:     hash_path = Path(str(snap_path).replace(".snapshot.json", ".sha256"))
0215:     if not hash_path.exists():
0216:         raise FileNotFoundError(f"Hash file не найден: {hash_path}")
0217: 
0218:     ok, msg = verify_snapshot_files(snap_path, hash_path)
0219:     if not ok:
0220:         raise ValueError(f"VERIFY_FAIL: {msg}")
0221: 
0222:     hash_hex = hash_path.read_text(encoding="utf-8").strip()
0223:     approval_path = approval_file_for_hash(hash_hex)
0224:     if not approval_path.exists():
0225:         raise PermissionError(f"NO_APPROVAL: нет файла подтверждения {approval_path}")
0226: 
0227:     # Загружаем то, что заморожено
0228:     task = read_json(TASK_JSON_PATH)
0229:     arch_decision = read_json(snap_path)

=== CONTEXT around line 305 (280-326) ===
0280:         "keywords": "keywords.json",
0281:         "anchors": "anchors.json",
0282:         "patient_questions": "patient_questions.json",
0283:         "final_artifacts": "final_artifacts.json",
0284:     }
0285: 
0286:     for key, filename in parts.items():
0287:         part_path = out_dir / filename
0288:         write_json_pretty(part_path, deliverables.get(key, {}))
0289: 
0290: 
0291:     print("EXECUTE_OK")
0292:     print(f"RAW:  {raw_path}")
0293:     print(f"JSON: {json_path}")
0294: 
0295: 
0296: def main(argv: list[str]) -> int:
0297:     parser = argparse.ArgumentParser(prog="orchestrator", description="Two-pass LLM workflow orchestrator")
0298:     sub = parser.add_subparsers(dest="cmd", required=True)
0299: 
0300:     sub.add_parser("decide", help="Run PASS_1 (DECIDE)")
0301: 
0302:     p_approve = sub.add_parser("approve", help="Approve a snapshot (human step)")
0303:     p_approve.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0304: 
0305:     p_execute = sub.add_parser("execute", help="Run PASS_2 (EXECUTE) with verified+approved snapshot")
0306:     p_execute.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0307: 
0308:     args = parser.parse_args(argv)
0309: 
0310:     try:
0311:         if args.cmd == "decide":
0312:             cmd_decide()
0313:         elif args.cmd == "approve":
0314:             cmd_approve(args.snapshot)
0315:         elif args.cmd == "execute":
0316:             cmd_execute(args.snapshot)
0317:         else:
0318:             raise ValueError(f"Unknown command: {args.cmd}")
0319:         return 0
0320:     except Exception as e:
0321:         print(f"ERROR: {e}", file=sys.stderr)
0322:         return 1
0323: 
0324: 
0325: if __name__ == "__main__":
0326:     raise SystemExit(main(sys.argv[1:]))

=== CONTEXT around line 306 (281-326) ===
0281:         "anchors": "anchors.json",
0282:         "patient_questions": "patient_questions.json",
0283:         "final_artifacts": "final_artifacts.json",
0284:     }
0285: 
0286:     for key, filename in parts.items():
0287:         part_path = out_dir / filename
0288:         write_json_pretty(part_path, deliverables.get(key, {}))
0289: 
0290: 
0291:     print("EXECUTE_OK")
0292:     print(f"RAW:  {raw_path}")
0293:     print(f"JSON: {json_path}")
0294: 
0295: 
0296: def main(argv: list[str]) -> int:
0297:     parser = argparse.ArgumentParser(prog="orchestrator", description="Two-pass LLM workflow orchestrator")
0298:     sub = parser.add_subparsers(dest="cmd", required=True)
0299: 
0300:     sub.add_parser("decide", help="Run PASS_1 (DECIDE)")
0301: 
0302:     p_approve = sub.add_parser("approve", help="Approve a snapshot (human step)")
0303:     p_approve.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0304: 
0305:     p_execute = sub.add_parser("execute", help="Run PASS_2 (EXECUTE) with verified+approved snapshot")
0306:     p_execute.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0307: 
0308:     args = parser.parse_args(argv)
0309: 
0310:     try:
0311:         if args.cmd == "decide":
0312:             cmd_decide()
0313:         elif args.cmd == "approve":
0314:             cmd_approve(args.snapshot)
0315:         elif args.cmd == "execute":
0316:             cmd_execute(args.snapshot)
0317:         else:
0318:             raise ValueError(f"Unknown command: {args.cmd}")
0319:         return 0
0320:     except Exception as e:
0321:         print(f"ERROR: {e}", file=sys.stderr)
0322:         return 1
0323: 
0324: 
0325: if __name__ == "__main__":
0326:     raise SystemExit(main(sys.argv[1:]))

=== CONTEXT around line 315 (290-326) ===
0290: 
0291:     print("EXECUTE_OK")
0292:     print(f"RAW:  {raw_path}")
0293:     print(f"JSON: {json_path}")
0294: 
0295: 
0296: def main(argv: list[str]) -> int:
0297:     parser = argparse.ArgumentParser(prog="orchestrator", description="Two-pass LLM workflow orchestrator")
0298:     sub = parser.add_subparsers(dest="cmd", required=True)
0299: 
0300:     sub.add_parser("decide", help="Run PASS_1 (DECIDE)")
0301: 
0302:     p_approve = sub.add_parser("approve", help="Approve a snapshot (human step)")
0303:     p_approve.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0304: 
0305:     p_execute = sub.add_parser("execute", help="Run PASS_2 (EXECUTE) with verified+approved snapshot")
0306:     p_execute.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0307: 
0308:     args = parser.parse_args(argv)
0309: 
0310:     try:
0311:         if args.cmd == "decide":
0312:             cmd_decide()
0313:         elif args.cmd == "approve":
0314:             cmd_approve(args.snapshot)
0315:         elif args.cmd == "execute":
0316:             cmd_execute(args.snapshot)
0317:         else:
0318:             raise ValueError(f"Unknown command: {args.cmd}")
0319:         return 0
0320:     except Exception as e:
0321:         print(f"ERROR: {e}", file=sys.stderr)
0322:         return 1
0323: 
0324: 
0325: if __name__ == "__main__":
0326:     raise SystemExit(main(sys.argv[1:]))

=== CONTEXT around line 316 (291-326) ===
0291:     print("EXECUTE_OK")
0292:     print(f"RAW:  {raw_path}")
0293:     print(f"JSON: {json_path}")
0294: 
0295: 
0296: def main(argv: list[str]) -> int:
0297:     parser = argparse.ArgumentParser(prog="orchestrator", description="Two-pass LLM workflow orchestrator")
0298:     sub = parser.add_subparsers(dest="cmd", required=True)
0299: 
0300:     sub.add_parser("decide", help="Run PASS_1 (DECIDE)")
0301: 
0302:     p_approve = sub.add_parser("approve", help="Approve a snapshot (human step)")
0303:     p_approve.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0304: 
0305:     p_execute = sub.add_parser("execute", help="Run PASS_2 (EXECUTE) with verified+approved snapshot")
0306:     p_execute.add_argument("--snapshot", required=True, help="Path to *.snapshot.json")
0307: 
0308:     args = parser.parse_args(argv)
0309: 
0310:     try:
0311:         if args.cmd == "decide":
0312:             cmd_decide()
0313:         elif args.cmd == "approve":
0314:             cmd_approve(args.snapshot)
0315:         elif args.cmd == "execute":
0316:             cmd_execute(args.snapshot)
0317:         else:
0318:             raise ValueError(f"Unknown command: {args.cmd}")
0319:         return 0
0320:     except Exception as e:
0321:         print(f"ERROR: {e}", file=sys.stderr)
0322:         return 1
0323: 
0324: 
0325: if __name__ == "__main__":
0326:     raise SystemExit(main(sys.argv[1:]))