name: CI (enforce post-check)

on:
  push:
  pull_request:

jobs:
  enforce-post-check:
    runs-on: ubuntu-latest
    env:
      SMOKE_TEST: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (if requirements.txt exists)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: POST-CHECK (must fail without merge_id)
        run: |
          set -e
          python scripts/check_deliverables.py

      - name: Resolve snapshot_id (latest)
        id: snapshot
        shell: bash
        run: |
          set -euo pipefail
          SNAPSHOT_ID="$(ls -1t state/snapshots/*.snapshot.json | head -n 1 | xargs -n 1 basename | sed 's/\.snapshot\.json$//')"
          if [ -z "$SNAPSHOT_ID" ]; then
            echo "No snapshot_id found in state/snapshots/"
            exit 1
          fi
          echo "snapshot_id=$SNAPSHOT_ID" >> "$GITHUB_OUTPUT"

      - name: APPROVE (human step mechanized)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator approve --snapshot "${{ steps.snapshot.outputs.snapshot_id }}"

      - name: PASS_2A — EXECUTE (CORE)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator execute \
            --stage core \
            --snapshot "state/snapshots/${{ steps.snapshot.outputs.snapshot_id }}.snapshot.json"

      - name: PASS_2B — EXECUTE (ANCHORS)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator execute \
            --stage anchors \
            --snapshot "state/snapshots/${{ steps.snapshot.outputs.snapshot_id }}.snapshot.json"

      - name: MERGE (terminal)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.snapshot.outputs.snapshot_id }}"
          python -m scripts.merge_pass2 \
            --core-snapshot-id "$RUN_ID" \
            --anchors-snapshot-id "$RUN_ID"

      - name: Run POST-CHECK (must fail without merge_id)
        run: |
          set -e
          python scripts/check_deliverables.py

