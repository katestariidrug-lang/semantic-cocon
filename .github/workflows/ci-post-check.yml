name: "CI: get canonical merge_id (debug)"

"on":
  push:
  pull_request:

jobs:
  get-merge-id:
    runs-on: ubuntu-latest
    env:
      SMOKE_TEST: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install python-dotenv
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: PASS_1 — DECIDE
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator decide

      - name: Resolve snapshot_id (latest)
        id: snapshot
        shell: bash
        run: |
          set -euo pipefail
          SNAPSHOT_ID="$(ls -1t state/snapshots/*.snapshot.json | head -n 1 | xargs -n 1 basename | sed 's/\.snapshot\.json$//')"
          test -n "$SNAPSHOT_ID"
          echo "snapshot_id=$SNAPSHOT_ID" >> "$GITHUB_OUTPUT"

      - name: APPROVE (human step mechanized)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator approve --snapshot "${{ steps.snapshot.outputs.snapshot_id }}"

      - name: PASS_2A — EXECUTE (CORE)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator execute \
            --stage core \
            --snapshot "state/snapshots/${{ steps.snapshot.outputs.snapshot_id }}.snapshot.json"

      - name: PASS_2B — EXECUTE (ANCHORS)
        shell: bash
        run: |
          set -euo pipefail
          python -m scripts.orchestrator execute \
            --stage anchors \
            --snapshot "state/snapshots/${{ steps.snapshot.outputs.snapshot_id }}.snapshot.json"

      - name: MERGE (terminal)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.snapshot.outputs.snapshot_id }}"
          python -m scripts.merge_pass2 \
            --core-snapshot-id "$RUN_ID" \
            --anchors-snapshot-id "$RUN_ID"

      - name: Print canonical merge_id (debug)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ steps.snapshot.outputs.snapshot_id }}"
          POINTER="state/merges/by_run/${RUN_ID}.merge_id"
          test -f "$POINTER"
          MERGE_ID="$(cat "$POINTER" | tr -d '[:space:]')"
          test -n "$MERGE_ID"
          echo "MERGE_ID=$MERGE_ID"
