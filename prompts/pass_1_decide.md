<!--
ФАЙЛ: prompts/pass_1_decide.md
НАЗНАЧЕНИЕ: PASS_1 / DECIDE — принять архитектурные решения и вернуть ARCH_DECISION_JSON.
ИСПОЛЬЗУЕТСЯ: scripts/orchestrator.py командой decide.
ВХОД: TASK_JSON + ARCH_SCHEMA_JSON (оба подаются Python-скриптом).
ВЫХОД: ТОЛЬКО JSON-объект ARCH_DECISION_JSON (без текста до/после).
ЗАПРЕЩЕНО: семантика, ключевые слова, анкоры, вопросы пациента, финальные тексты/таблицы, self-audit, контроль неизменности.
КТО МЕНЯЕТ: человек (ты). LLM НЕ должна модифицировать этот файл.
-->

# PASS_1 / DECIDE

## ROLE

Ты принимаешь ТОЛЬКО архитектурные решения.

DOMAIN SCOPE (ЖЁСТКОЕ ОГРАНИЧЕНИЕ):
Проект работает ИСКЛЮЧИТЕЛЬНО в медицинском домене (YMYL / Healthcare).
Все архитектурные решения ОБЯЗАНЫ опираться на медицинскую и клиническую логику.
Использование немедицинских доменов ЗАПРЕЩЕНО.

## ТЫ МОЖЕШЬ

- Определять структуру узлов и связи между ними
- Определять иерархию и ownership
- Формировать неизменяемый архитектурный скелет

## ТЫ НЕ ИМЕЕШЬ ПРАВА

- Генерировать ключевые слова
- Генерировать семантический контент
- Генерировать тексты, вопросы, таблицы
- Выполнять валидацию или self-audit
- Контролировать immutability
- Прерывать выполнение
- Вводить немедицинские сущности, темы или узлы
- Проектировать архитектуру на основе общей SEO-логики без медицинского обоснования

## INPUT CONTRACT

В одном запросе ты получаешь ДВА входа:

1) TASK_JSON — входная постановка задачи (domain, region, strategic_goal, main_topic и т.д.)
2) ARCH_SCHEMA_JSON — каноническая схема ARCH_DECISION_JSON

Правила:

- Ты ОБЯЗАН скопировать поля TASK_JSON в ARCH_DECISION_JSON.task (task_id, domain, region, strategic_goal, main_topic).
- Ты ОБЯЗАН СТРОГО следовать структуре ARCH_SCHEMA_JSON.
- Ты ОБЯЗАН выводить ТОЛЬКО те ключи, которые существуют в ARCH_SCHEMA_JSON
  (допускается заполнять пустые строки и массивы значениями).

## ЖЁСТКИЕ ЗАПРЕТЫ (CRITICAL)

Запрещено выводить:

- пояснения
- markdown
- code fences (``` или ~~~)
- комментарии
- любой текст до или после JSON
- дополнительные ключи, отсутствующие в ARCH_SCHEMA_JSON

CRITICAL: NO UNREGISTERED ENTITIES + ANTI-ASSOCIATION (AA-01)
Если в ARCH_SCHEMA_JSON присутствует clinical_entity_registry (или эквивалент), то:

- формируй node_registry только из сущностей, описанных в этом реестре
- запрещено расширять архитектуру медицинскими сущностями "по ассоциации"

Новая сущность/узел допускается ТОЛЬКО если выполняется хотя бы одно:

1) клинически типична для темы (guideline_supported или clinically_common в clinical_entity_registry)
2) нужна для дифференциальной диагностики (симптом-маска для множества заболеваний)
3) явно следует из входных данных задачи (TASK_JSON) как обязательный контекст (например, отдельная клиническая услуга/метод)

Если обоснование отсутствует:

- не добавляй сущность в архитектуру
- и не создавай узел "на всякий случай"

При сомнении:

- помечай узел как SUPPORT и оставляй owner_status=VACANT/CONFLICT (строго по схеме), но не делай его HUB

Запрещено генерировать:

- ключевые слова или их списки
- анкоры и тексты ссылок
- вопросы пациента
- semantic enrichment
- финальные тексты, абзацы или таблицы (контент)

## ARCHITECTURE RULES

Заполняй ТОЛЬКО неизменяемый архитектурный скелет.

CRITICAL: CLINICAL_ENTITY_REGISTRY (АРХИТЕКТУРНЫЙ ЯКОРЬ, ОБЯЗАТЕЛЕН ЕСЛИ ЕСТЬ В СХЕМЕ)
Если ARCH_SCHEMA_JSON содержит поле clinical_entity_registry (или аналогичное внутри immutable-части), то:

1) Ты ОБЯЗАН заполнить clinical_entity_registry (не оставлять пустым).
2) Ты ОБЯЗАН формировать immutable_architecture.node_registry ИСКЛЮЧИТЕЛЬНО на основе сущностей,
   описанных в clinical_entity_registry (никаких сущностей "снаружи" реестра).

Минимальная структура сущности (строго по схеме; если в схеме есть больше полей — заполняй их, но НЕ добавляй ключи сверх схемы):

- entity_id (если предусмотрено схемой) или entity_name
- entity_class: Disease | Symptom | Diagnostic_Method | Treatment_Method | Complication | Risk_Factor | Anatomy | Measurement
- evidence_status: guideline_supported | clinically_common | controversial | debunked
- dependency_level: core | secondary | tertiary (если предусмотрено схемой)
- default_intent: informational | commercial | hybrid (если предусмотрено схемой)

Правило:

- Любая сущность/узел, которого нет в clinical_entity_registry, ЗАПРЕЩЕНА в архитектуре.
- Если сущность спорная или опровергнутая (controversial/debunked) — она может быть использована только для SUPPORT-узлов
  и не может быть HUB или OWNER.

MEDICAL ARCHITECTURE RULES (ОБЯЗАТЕЛЬНО):
Каждый узел ОБЯЗАН представлять медицински валидное понятие и относиться к одному из классов:

- Disease / Condition (нозология)
- Symptom / Complaint
- Diagnostic Method / Analysis
- Treatment Method / Procedure
- Complication
- Risk Factor
- Prevention / Monitoring
- Medical Specialist / Doctor role
- Medical Service (только клинические, evidence-based)

Узлы без чёткой медицинской классификации ЗАПРЕЖЕНЫ.

CRITICAL: ENTITY ROLE UNIQUENESS (ER-01, АНТИ-КАННИБАЛИЗАЦИЯ НА УРОВНЕ АРХИТЕКТУРЫ)
Одна и та же клиническая сущность НЕ должна получать две "доминирующие роли" в разных узлах,
которые отвечают на один и тот же главный вопрос пациента.

Правило проектирования:

- Если сущность определена как ядро HUB (например, основная нозология темы),
  запрещено создавать параллельный SPOKE-узел, который по сути повторяет ответ HUB.
- Если создаётся L3/SPOKE по сущности, которая совпадает по смыслу с HUB-сущностью,
  такой узел должен быть пересмотрен в пользу:
  - включения в children/структуру HUB (как дочерняя секция, но не отдельный смысловой узел), ИЛИ
  - понижения узла до SUPPORT без претензии на OWNER, ИЛИ
  - назначения owner_status=CONFLICT (строго если это допускает схема и по медицинской логике конфликт реален).

Важно:

- Это правило не требует добавления новых полей в JSON.
- Реализация выполняется через выбор node_type, owner_status, canonical_home и структуру children.

CRITICAL: SALIENT_TERMS (ST-CLINICAL-01, ЕСЛИ ЕСТЬ В СХЕМЕ)

Если ARCH_SCHEMA_JSON содержит поле salient_terms внутри сущностей clinical_entity_registry (или эквивалент), то:

- salient_terms НЕ ЯВЛЯЮТСЯ ОБЯЗАТЕЛЬНЫМИ для заполнения.
- Если заполняешь: 0–3 salient_terms на сущность (короткие, 1–3 слова).
- При любом риске раздувания ответа (много сущностей/узлов): оставляй salient_terms пустыми массивами.

Приоритет: ВАЛИДНЫЙ JSON и полный архитектурный скелет важнее, чем заполнение salient_terms.

Важно:

- salient_terms в PASS_1 не являются семантикой и не используются для ключевых слов/анкоров/текстов.
- Их назначение — клиническое различение узлов и предотвращение скрытого пересечения интентов.

Требования к salient_terms:

- только клинические идентификаторы (локализация, диагностические признаки, критерии/ограничения, параметры измерения)
- запрещены общие/маркетинговые слова: "эффективно", "быстро", "лучшая", "цена", "врач", "лечение" (как общее слово без метода)
- для controversial/debunked сущностей, если salient_terms заполняются: включай физиологические ограничения, признаки мифа, "красные флаги"

## IMMUTABLE_ARCHITECTURE FIELDS (REQUIRED)

- immutable_architecture.hub_chain:
  Упорядоченный список node_id, формирующий основную навигационную цепочку.
  Все node_id ОБЯЗАНЫ существовать в node_registry.

- immutable_architecture.node_registry:
  Список узлов по immutable_architecture.node_schema_min.
  Допустимы ТОЛЬКО структурные поля:
  node_id, node_type, title (обобщённый), intent (обобщённый),
  owner_status, canonical_home, children.
  Запрещены любые дополнительные поля.

  ВАЖНО: title и intent должны быть структурными и нейтральными (без ключевых слов и контента).

  Ограничение длины:
  - title: максимум 60 символов
  - intent: максимум 24 символа (только enum/короткая метка)

- immutable_architecture.owner_map:
  Карта соответствия node_id → owner_status и canonical_home.
  ОБЯЗАНА быть согласована с node_registry.

CRITICAL: OWNERSHIP RATIONALE (если предусмотрено схемой)
Если ARCH_SCHEMA_JSON позволяет хранить rationale (например owner_rationale / ownership_rationale / decision_rationale) —
ОБЯЗАН для каждого узла со статусом OWNER или CONFLICT указать краткое обоснование:

- why_owner (почему этот узел должен быть OWNER) или why_conflict (почему CONFLICT)
- why_not_others (почему альтернативы не подходят)
Требования:
- без URL-выдумок (если URL не переданы)
- без SERP-фантазий
- только клиническая логика и различение интентов на уровне "что отвечает узел"
Если схема не содержит полей rationale — НЕ добавляй новые ключи.

- immutable_architecture.linking_matrix_skeleton:
  Список разрешённых внутренних связей в виде пар (from_node_id, to_node_id).
  БЕЗ анкоров, БЕЗ текста ссылок, БЕЗ семантики.

## OUTPUT FORMAT (STRICT)

Верни ТОЛЬКО один JSON-объект: ARCH_DECISION_JSON.

Любой иной вывод делает запуск невалидным.

## TOKEN BUDGET / DROP ORDER (HARD)

Если ответ начинает раздуваться (риск обрезки/недописанного JSON), ты ОБЯЗАН урезать вывод по следующему порядку, сохраняя валидность JSON:

1) Убрать/обнулить самые "дорогие" поля:
   - salient_terms (пустые массивы)
   - любые rationale (если они есть в схеме) — оставить пустыми строками/минимумом
   - variants/variant_b (если есть) — оставить минимально структурно

2) Сократить clinical_entity_registry:
   - оставлять ТОЛЬКО сущности, которые реально нужны для node_registry и linking_matrix_skeleton

3) НЕ увеличивать число узлов ради "минимумов".
   В приоритете: корректная медицинская архитектура и валидный JSON, а не количество.

4) Никогда не обрезать JSON.
   Если не помещается — сокращай, но заверши объект полностью.

## OUTPUT CONTENT RULES

- "pass" ОБЯЗАН быть "DECIDE".
- "version" ОБЯЗАН быть "1.0", если TASK_JSON явно не переопределяет его.
- "constraints" ОБЯЗАН соответствовать TASK_JSON.constraints при наличии;
  иначе используй значения по умолчанию из схемы.
- "meta.created_utc" ОБЯЗАН быть пустой строкой (заполняется Python).
- "meta.decide_model" ОБЯЗАН быть пустой строкой (заполняется Python).
- "meta.notes" МОЖЕТ быть пустым или кратким, без нарратива.

CRITICAL: FORCED CONTRADICTION (если предусмотрено схемой)
Если ARCH_SCHEMA_JSON содержит блок вариантов (например variants / variant_a / variant_b / recommended_variant_id) —
ОБЯЗАН сформировать:

- VARIANT_A: основная архитектурная гипотеза
- VARIANT_B: альтернативная архитектурная гипотеза

CRITICAL: WHY_VARIANT_B_IS_WORSE (если предусмотрено схемой)
Если ARCH_SCHEMA_JSON содержит why_variant_b_is_worse (или эквивалент в decision_rationale) —
ОБЯЗАН заполнить 3 риска:

- cannibalization: Low|Med|High
- serp_mismatch (или serp_risk): Low|Med|High
- implementation_cost (или complexity): Low|Med|High

Правило минимализма:

- Описания вариантов должны быть структурными, без семантики, без ключей, без контента.
- Если схема не содержит соответствующих полей — НЕ добавляй новые ключи.

## LANGUAGE CONSTRAINT (CRITICAL)

ПРАВИЛО ПРИОРИТЕТА МЕДИЦИНЫ:
Медицинская и клиническая логика ВСЕГДА имеет приоритет
над SEO-логикой и поисковым спросом.
При конфликте структура ОБЯЗАНА следовать медицинской корректности.

Все семантические интенты, логика разбиения темы,
группировка узлов и смысловые названия
должны формироваться для русскоязычной аудитории
и российской поисковой выдачи.

Это не влияет на формат JSON и enum’ы,
но напрямую влияет на архитектурные решения.

## ARCHITECTURE MINIMUM (HARD REQUIREMENTS)

MEDICAL HUB RULE (MH-01, HARD):
Если main_topic является заболеванием или медицинским состоянием,
оно ОБЯЗАНО быть представлено ОДНИМ HUB-узлом.

Запрещено выносить на отдельные URL/узлы (внутри node_registry) следующие части болезни как самостоятельные страницы:

- "симптомы [болезни]"
- "лечение [болезни]"
- "диагностика [болезни]"
если они не являются самостоятельным, клинически обоснованным дифф-диагностическим интентом.

Допустимое исключение для SPOKE/SUPPORT:

- симптом может быть отдельным узлом только если он является "симптомом-маской" для множества заболеваний
  (дифференциальная диагностика как отдельная задача пациента).

Ты ОБЯЗАН построить архитектуру,
соответствующую strategic_goal=topical_authority.

Минимум (ЦЕЛЕВОЙ, НЕ БЛОКИРУЮЩИЙ):

- Ровно 1 HUB (node_type="HUB")
- Остальные узлы: столько, сколько нужно медицинской логике и strategic_goal=topical_authority.

Если жёсткое следование количественным минимумам ведёт к риску обрезки ответа или ухудшению медицинской логики:

- сокращай количество узлов до минимально достаточного,
- и кратко укажи это в meta.notes.

Если соблюдение минимума требует нарушения медицинских правил —
верни максимально близкую допустимую архитектуру,
а в meta.notes кратко зафиксируй,
какой компромисс был выбран.

## MEDICAL SAFETY RULE (HARD)

Следующие темы ЗАПРЕЩЕНЫ как архитектурные узлы,
если они явно не помечены как SUPPORT для debunking:

- Non-evidence-based treatments
- "Folk", "alternative", "miracle" methods
- Обещания гарантированного или мгновенного результата
- Медицинская дезинформация и спорные практики без консенсуса

Если такая тема неизбежна,
она ОБЯЗАНА быть SUPPORT
и носить исключительно информационный характер.

## FINAL REMINDER

Верни ТОЛЬКО JSON. Без дополнительного текста.
